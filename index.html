<!DOCTYPE html>
<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>普普風配對遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shrikhand&display=swap');
        
        /* 自定義普普風顏色 */
        .pop-pink { background-color: #FF69B4; }
        .pop-yellow { background-color: #FFD700; }
        .pop-blue { background-color: #00BFFF; }
        .pop-green { background-color: #32CD32; }
        .pop-red { background-color: #FF4500; }
        .pop-purple { background-color: #9370DB; }
        
        /* 普普風字體 */
        h1, h2, .font-pop {
            font-family: 'Shrikhand', cursive;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        /* 注音字體 */
        @font-face {
            font-family: 'ㄅ注音芫荽 Regular';
            src: url('https://kentxchang-goedutw.github.io/web/BpmfIansui-Regular_0.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        /* 讓整個 body 在使用注音模式時，所有文字都預設套用注音字體 */
        .use-zhuyin {
            font-family: 'ㄅ注音芫荽 Regular', sans-serif !important;
        }

        body {
            background-image: linear-gradient(45deg, #FF69B4, #FFD700, #00BFFF);
            animation: background-animate 15s ease infinite;
            background-size: 300% 300%;
        }

        @keyframes background-animate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            cursor: pointer;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            border: 4px solid black;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.3);
        }

        .card.matched {
            animation: matched-pop 0.5s forwards;
        }

        @keyframes matched-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        .card.unmatched {
            animation: unmatched-shake 0.5s;
        }

        @keyframes unmatched-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .game-board {
            display: grid;
            gap: 16px;
        }

        .btn-style {
            transition: all 0.2s ease-in-out;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
            border: 3px solid black;
        }

        .btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.3);
        }
        
        .mode-button {
             filter: brightness(0.8);
        }

        .mode-button.active {
            filter: brightness(1.2);
        }

        /* 打地鼠模式特有樣式 */
        #whac-a-mole-question {
            min-height: 8rem;
        }
        .mole-hole {
            position: relative;
            background-color: #6d4c41; /* 土壤顏色 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 4px solid black;
        }
        .mole-card {
            position: absolute;
            top: 0; /* 固定在洞口位置 */
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* 預設完全透明 */
            visibility: hidden; /* 預設隱藏 */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; /* 淡入淡出動畫 */
            cursor: pointer;
            border: none;
            box-shadow: none;
            border-radius: 50%;
        }
        .mole-card.popped {
            opacity: 1; /* 淡入並顯示 */
            visibility: visible;
        }

        /* 翻卡練習模式特有樣式 (3D Flip) */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .transform-rotate-y-180 {
            transform: rotateY(180deg);
        }
        #flashcard-back {
            transform: rotateY(180deg); /* 預設反面翻轉 180 度 */
        }
        /* 讓整個卡片容器可以點擊 */
        #flashcard-container {
            cursor: pointer;
        }
    </style>
</head>
<body class="p-8 text-white min-h-screen flex flex-col items-center">

    <div class="fixed top-4 right-4 text-xs font-pop text-black opacity-70">Made by 阿剛老師</div>

    <!-- 遊戲模式選擇區塊 (現在是頂部的主要區塊) -->
    <div id="game-options" class="w-full max-w-4xl mx-auto bg-white/20 backdrop-blur-lg rounded-3xl p-6 shadow-xl border-4 border-white mb-8">
        
        <!-- Main row for two columns: Toggle (Left) and Mode Buttons (Right) -->
        <div class="flex flex-col lg:flex-row justify-between items-center space-y-6 lg:space-y-0 lg:space-x-8">
            
            <!-- Column 1 (Left): 注音字體開關 -->
            <div class="flex justify-center items-center lg:justify-start lg:w-1/3">
                <span class="text-xl font-bold text-black mr-4 whitespace-nowrap">注音字體開關:</span>
                <label for="zhuyin-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="zhuyin-toggle" class="sr-only peer">
                    <!-- Toggle switch visual component -->
                    <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pop-pink rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-pop-pink"></div>
                </label>
            </div>

            <!-- Column 2 (Right): 選擇遊戲模式 & Buttons -->
            <div class="w-full lg:w-2/3 text-center lg:text-right">
                <!-- 在桌面版時隱藏此標題，因為空間較為緊湊；在移動版時顯示 -->
                <h2 class="text-2xl font-bold text-black mb-4 lg:hidden">選擇遊戲模式</h2> 
                
                <div class="flex flex-col sm:flex-row justify-center lg:justify-end space-y-4 sm:space-y-0 sm:space-x-4">
                    <!-- 翻卡練習 -->
                    <button class="mode-button btn-style pop-pink text-white py-3 px-6 rounded-xl text-lg font-bold" data-mode="flashcard">
                        翻卡練習
                    </button>
                    <!-- 隨機配對 -->
                    <button class="mode-button btn-style pop-blue text-white py-3 px-6 rounded-xl text-lg font-bold" data-mode="random-match">
                        隨機配對
                    </button>
                    <!-- 打地鼠 -->
                    <button class="mode-button btn-style pop-green text-white py-3 px-6 rounded-xl text-lg font-bold" data-mode="whac-a-mole">
                        打地鼠
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <!-- 貼上你的題目區塊 (現已隱藏，保留內容以供自動載入) -->
    <div id="input-area-container" class="w-full max-w-4xl bg-white/20 backdrop-blur-lg rounded-3xl p-6 shadow-xl border-4 border-white mb-8 hidden">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
            <div class="w-full">
                <h2 class="text-2xl font-bold text-black mb-2">貼上你的題目</h2>
                <!-- 預先填入範例內容，以便首次載入時自動啟動 -->
                <textarea id="question-input" rows="5" class="w-full p-3 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-4 focus:ring-pop-blue border-2 border-gray-300 transition-all" placeholder="每行一組，例如：
蘋果,apple
香蕉	banana
...">舊石器時代	人們敲打石頭製作生活所需工具，並透過採集、狩獵及捕魚維持生活的方式。
史前時代	人類尚未出現文字的時期。
八仙洞	位於臺東縣長濱鄉，是當地山壁上大大小小洞穴的統稱。
金屬器時代	臺灣史前人類開始使用與製作各種鐵器後邁入的時代。
考古遺址	史前時代人類活動的地方，其中發現的遺物和遺跡是考古學家研究人類發展的重要依據。</textarea>
            </div>
            <div class="flex-shrink-0">
                <button id="generate-btn" class="btn-style pop-red text-white py-3 px-6 rounded-xl text-lg font-bold">
                    產生題目
                </button>
            </div>
        </div>
    </div>

    
    <div id="game-container" class="w-full max-w-4xl bg-white/20 backdrop-blur-lg rounded-3xl p-6 shadow-xl border-4 border-white">
        
        <!-- 翻卡練習介面 -->
        <div id="flashcard-area" class="hidden flex flex-col items-center">
            <div id="card-status" class="text-xl font-bold text-black mb-4"></div>
            <div id="flashcard-container" class="w-full max-w-md h-64 md:h-80 perspective-1000">
                <div id="flashcard-card" class="relative w-full h-full transform-style-preserve-3d transition-transform duration-500 shadow-2xl rounded-xl border-4 border-black">
                    <!-- 正面內容 -->
                    <div id="flashcard-front" class="absolute w-full h-full backface-hidden flex items-center justify-center pop-yellow rounded-xl p-4 text-black text-3xl font-bold">
                        正面內容
                    </div>
                    <!-- 反面內容 -->
                    <div id="flashcard-back" class="absolute w-full h-full backface-hidden transform-rotate-y-180 flex items-center justify-center pop-blue rounded-xl p-4 text-white text-3xl font-bold">
                        反面內容
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center space-x-2 sm:space-x-4 mt-6">
                <button id="prev-card-btn" class="btn-style pop-red text-white py-2 px-4 rounded-xl text-base font-bold" disabled="">
                    上一頁
                </button>
                <button id="speak-btn" class="btn-style pop-green text-white py-2 px-4 rounded-xl text-base font-bold">
                    播音 🔊
                </button>
                <button id="next-card-btn" class="btn-style pop-red text-white py-2 px-4 rounded-xl text-base font-bold">
                    下一頁
                </button>
            </div>
        </div>
        
        <!-- 其他遊戲介面 -->
        <!-- game-info 用於顯示計時器 -->
        <div id="game-info" class="text-center mb-4 text-2xl font-bold text-black rounded-xl p-2 border-2 border-black inline-block"></div>
        <div id="whac-a-mole-question" class="text-center text-4xl font-bold text-black mb-6 flex items-center justify-center hidden pop-yellow rounded-xl p-4 border-4 border-black"></div>
        <div id="game-board" class="game-board justify-center"></div>
        <div id="status-message" class="text-center text-3xl font-pop mt-4 text-black"></div>
        <div class="flex justify-center mt-6">
            <button id="restart-btn" class="btn-style pop-red text-white py-3 px-6 rounded-xl text-lg font-bold hidden">
                重新開始
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputAreaContainer = document.getElementById('input-area-container');
            const questionInput = document.getElementById('question-input');
            const generateBtn = document.getElementById('generate-btn');
            const gameBoard = document.getElementById('game-board');
            const statusMessage = document.getElementById('status-message');
            const gameInfo = document.getElementById('game-info');
            const restartBtn = document.getElementById('restart-btn');
            const modeButtons = document.querySelectorAll('.mode-button');
            const whacAMoleQuestion = document.getElementById('whac-a-mole-question');
            
            // 新增注音開關元素
            const body = document.body;
            const zhuyinToggle = document.getElementById('zhuyin-toggle');

            // 翻卡練習元素
            const flashcardArea = document.getElementById('flashcard-area');
            const flashcardContainer = document.getElementById('flashcard-container');
            const flashcardCard = document.getElementById('flashcard-card');
            const flashcardFront = document.getElementById('flashcard-front');
            const flashcardBack = document.getElementById('flashcard-back');
            const cardStatus = document.getElementById('card-status');
            const prevCardBtn = document.getElementById('prev-card-btn');
            const nextCardBtn = document.getElementById('next-card-btn');
            const speakBtn = document.getElementById('speak-btn');

            let words = [];
            let shuffledWords = [];
            let flippedCards = [];
            let matchedCount = 0;
            let canFlip = true;
            let gameMode = 'flashcard';
            let pairedItems = [];
            let currentQuestion = null;
            let questionIndex = 0;
            let moleInterval = null;
            let moleTimeout = null;
            let activeMoles = [];
            
            // 翻卡練習狀態
            let cardIndex = 0;
            let isFlipped = false;

            // 計時器狀態
            let startTime = null;
            let timerInterval = null;

            const cardColors = ['pop-pink', 'pop-yellow', 'pop-blue', 'pop-green', 'pop-red', 'pop-purple'];
            const gameContainer = document.getElementById('game-container');

            function showStatus(message, bgColorClass) {
                statusMessage.innerText = message;
                // 清除所有背景色和字體色（如果設置了）
                statusMessage.classList.remove('pop-yellow', 'pop-green', 'pop-red', 'pop-blue', 'bg-pop-yellow', 'bg-pop-green', 'bg-pop-red', 'bg-pop-blue');
                
                // 預設為黑色字體，如果需要特定背景色則添加
                statusMessage.classList.add('text-black');

                if (bgColorClass) {
                    statusMessage.classList.add(bgColorClass, 'px-4', 'py-2', 'rounded-xl', 'font-bold');
                } else if (message === '') {
                    statusMessage.classList.remove('px-4', 'py-2', 'rounded-xl', 'font-bold');
                }
            }
            
            // --- 計時器功能 ---

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            function startTimer() {
                stopTimer(); // 確保清除舊的計時器
                startTime = Date.now();
                gameInfo.innerText = "時間: 00:00";
                gameInfo.classList.remove('hidden');

                timerInterval = setInterval(() => {
                    const elapsedSeconds = (Date.now() - startTime) / 1000;
                    gameInfo.innerText = `時間: ${formatTime(elapsedSeconds)}`;
                }, 1000);
            }

            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }

            // --- 語音合成 (TTS) ---
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    // 嘗試偵測語言或使用 zh-TW 作為預設
                    const isEnglish = /[a-zA-Z]/.test(text);
                    utterance.lang = isEnglish ? 'en-US' : 'zh-TW'; 

                    const voices = window.speechSynthesis.getVoices();
                    const targetVoice = voices.find(voice => voice.lang.includes(utterance.lang));
                    if (targetVoice) {
                        utterance.voice = targetVoice;
                    }
                    window.speechSynthesis.speak(utterance);
                } else {
                    showStatus('瀏覽器不支援語音播報功能。', 'pop-red');
                }
            }
            
            // --- 遊戲邏輯 ---

            function clearTimers() {
                stopTimer();
                if (moleInterval) {
                    clearInterval(moleInterval);
                    moleInterval = null;
                }
                if (moleTimeout) {
                    clearTimeout(moleTimeout);
                    moleTimeout = null;
                }
                activeMoles.forEach(mole => {
                    // 確保移除 popped 類別來觸發淡出
                    mole.classList.remove('popped');
                    mole.removeEventListener('click', handleWhacAMoleClick);
                });
                activeMoles = [];
            }

            function parseInput() {
                const inputText = questionInput.value.trim();
                if (!inputText) {
                    showStatus('請在編輯器中修改題目內容並重新整理頁面。', 'pop-blue');
                    return [];
                }
                const lines = inputText.split('\n');
                const pairs = [];
                let idCounter = 0;
                lines.forEach(line => {
                    // 使用 Tab 或逗號分隔
                    const parts = line.split(/[\t,]/).map(part => part.trim()).filter(part => part.length > 0);
                    if (parts.length === 2) {
                        pairs.push({ id: idCounter, word: parts[0], match: parts[1] });
                        idCounter++;
                    }
                });
                return pairs;
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function startGame(mode) {
                gameMode = mode;
                words = parseInput();
                clearTimers(); // 清除所有計時器
                
                gameBoard.innerHTML = '';
                gameInfo.innerText = '';
                gameInfo.classList.add('hidden'); // 預設隱藏計時器
                whacAMoleQuestion.classList.add('hidden');
                flashcardArea.classList.add('hidden');
                showStatus('', '');
                restartBtn.classList.add('hidden');

                if (words.length === 0) {
                    return;
                }
                
                // 模式按鈕高亮
                modeButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                matchedCount = 0;
                canFlip = true;


                if (gameMode === 'random-match') {
                    startRandomMatchGame();
                } else if (gameMode === 'whac-a-mole') {
                    startWhacAMoleGame();
                } else if (gameMode === 'flashcard') {
                    startFlashcardGame();
                }
            }

            // ====================================================================
            // 翻卡練習模式 (Flashcard Mode)
            // ====================================================================
            
            function startFlashcardGame() {
                gameBoard.style.gridTemplateColumns = '1fr';
                flashcardArea.classList.remove('hidden');
                gameInfo.classList.add('hidden'); // 翻卡模式不計時
                
                pairedItems = [...words];
                cardIndex = 0;
                isFlipped = false;
                
                if (pairedItems.length === 0) {
                    showStatus('請先貼上有效的配對題目！', 'pop-red');
                    return;
                }
                
                updateFlashcardDisplay();
            }

            function updateFlashcardDisplay() {
                if (pairedItems.length === 0) return;
                
                const cardData = pairedItems[cardIndex];
                
                // 更新內容
                flashcardFront.innerText = cardData.word;
                flashcardBack.innerText = cardData.match;
                
                // 重設翻轉狀態
                isFlipped = false;
                flashcardCard.style.transform = 'rotateY(0deg)';
                
                // 更新狀態
                cardStatus.innerText = `第 ${cardIndex + 1} / ${pairedItems.length} 張卡`;

                // 更新導航按鈕狀態
                prevCardBtn.disabled = cardIndex === 0;
                nextCardBtn.disabled = cardIndex === pairedItems.length - 1;

                // 調整字體大小以適應內容
                flashcardFront.style.fontSize = Math.min(30, 180 / Math.sqrt(cardData.word.length)) + 'px';
                flashcardBack.style.fontSize = Math.min(30, 180 / Math.sqrt(cardData.match.length)) + 'px';
            }

            function flipCard() {
                isFlipped = !isFlipped;
                if (isFlipped) {
                    flashcardCard.style.transform = 'rotateY(180deg)';
                } else {
                    flashcardCard.style.transform = 'rotateY(0deg)';
                }
            }

            function navigateCard(direction) {
                let newIndex = cardIndex + direction;
                
                if (newIndex >= 0 && newIndex < pairedItems.length) {
                    cardIndex = newIndex;
                    updateFlashcardDisplay();
                }
            }

            function handleSpeakClick() {
                const cardData = pairedItems[cardIndex];
                const textToSpeak = isFlipped ? cardData.match : cardData.word;
                speakText(textToSpeak);
            }

            prevCardBtn.addEventListener('click', () => navigateCard(-1));
            nextCardBtn.addEventListener('click', () => navigateCard(1));
            flashcardContainer.addEventListener('click', flipCard);
            speakBtn.addEventListener('click', handleSpeakClick);

            // ====================================================================
            // 隨機配對模式 (Random Match Mode)
            // ====================================================================

            function startRandomMatchGame() {
                whacAMoleQuestion.classList.add('hidden');
                gameBoard.innerHTML = '';
                
                const allWords = [];
                words.forEach(pair => {
                    allWords.push({ id: pair.id, word: pair.word });
                    allWords.push({ id: pair.id, word: pair.match });
                });
                shuffledWords = shuffle(allWords);

                shuffledWords.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.classList.add('card', 'flex', 'items-center', 'justify-center', 'text-center', 'p-4', 'rounded-lg', 'text-black', 'text-base', 'font-bold', 'select-none', 'h-32', 'sm:h-40');
                    card.dataset.index = index;
                    card.dataset.id = item.id;
                    card.innerText = item.word;
                    card.style.fontSize = Math.min(20, 160 / Math.sqrt(item.word.length)) + 'px';
                    card.classList.add(cardColors[Math.floor(Math.random() * cardColors.length)]);
                    card.addEventListener('click', handleRandomMatchClick);
                    gameBoard.appendChild(card);
                });

                // 根據使用者要求，固定為一列四欄呈現卡片
                const cols = 4;
                gameBoard.style.gridTemplateColumns = `repeat(${cols}, minmax(100px, 1fr))`;

                startTimer(); // 開始計時
            }

            function handleRandomMatchClick() {
                if (!canFlip) return;
                const clickedCard = this;
                
                if (flippedCards.includes(clickedCard) || clickedCard.classList.contains('matched')) {
                    return;
                }
                
                flippedCards.push(clickedCard);
                clickedCard.classList.remove(...cardColors);
                clickedCard.classList.add('pop-yellow', 'text-black');
                clickedCard.removeEventListener('click', handleRandomMatchClick);

                if (flippedCards.length === 2) {
                    canFlip = false;
                    const [card1, card2] = flippedCards;
                    
                    if (card1.dataset.id === card2.dataset.id) {
                        // Match
                        setTimeout(() => {
                            card1.classList.add('matched');
                            card2.classList.add('matched');
                            
                            flippedCards = [];
                            canFlip = true;
                            
                            matchedCount += 2;
                            if (matchedCount === shuffledWords.length) {
                                endGame(true);
                            }
                        }, 500);
                    } else {
                        // No match
                        setTimeout(() => {
                            card1.classList.remove('pop-yellow', 'text-black');
                            card2.classList.remove('pop-yellow', 'text-black');
                            
                            const randomColor1 = cardColors[Math.floor(Math.random() * cardColors.length)];
                            const randomColor2 = cardColors[Math.floor(Math.random() * cardColors.length)];
                            
                            card1.classList.add(randomColor1);
                            card2.classList.add(randomColor2);

                            card1.addEventListener('click', handleRandomMatchClick);
                            card2.addEventListener('click', handleRandomMatchClick);
                            flippedCards = [];
                            canFlip = true;
                        }, 1000);
                    }
                }
            }

            // ====================================================================
            // 打地鼠模式 (Whac-a-Mole Mode)
            // ====================================================================

            function startWhacAMoleGame() {
                whacAMoleQuestion.classList.remove('hidden');
                gameBoard.innerHTML = '';
                pairedItems = shuffle([...words]);
                questionIndex = 0;
                
                if (pairedItems.length === 0) {
                    endGame(false);
                    return;
                }
                
                // 建立9個地鼠洞
                gameBoard.style.gridTemplateColumns = 'repeat(3, 1fr)';
                for (let i = 0; i < 9; i++) {
                    const moleHole = document.createElement('div');
                    moleHole.classList.add('mole-hole', 'h-32', 'w-32', 'sm:h-40', 'sm:w-40');
                    gameBoard.appendChild(moleHole);
                }

                startTimer(); // 開始計時
                updateWhacAMoleGame();
            }

            function updateWhacAMoleGame() {
                if (questionIndex >= pairedItems.length) {
                    endGame(true);
                    return;
                }
                
                canFlip = true;
                showStatus('', '');

                currentQuestion = pairedItems[questionIndex];
                whacAMoleQuestion.innerText = currentQuestion.word;

                // 啟動地鼠出現的循環
                startMoleLoop();
            }

            function startMoleLoop() {
                clearTimers(); // 清除舊的 mole loop
                const moleHoles = document.querySelectorAll('.mole-hole');
                
                const popInterval = Math.random() * 1000 + 1000; // 1秒到2秒隨機間隔
                
                moleInterval = setInterval(() => {
                    // 移除上一批地鼠 (觸發淡出)
                    activeMoles.forEach(mole => mole.classList.remove('popped'));
                    activeMoles = [];
                    
                    const allPossibleAnswers = words.map(item => ({ id: item.id, word: item.match }));
                    const incorrectAnswers = allPossibleAnswers.filter(item => item.id !== currentQuestion.id);
                    const shuffledIncorrect = shuffle(incorrectAnswers);
                    
                    // 準備兩個答案，一個正確，一個錯誤
                    const answersToPop = shuffle([
                        { id: currentQuestion.id, word: currentQuestion.match },
                        // 確保至少有足夠的錯誤答案
                        shuffledIncorrect.length > 0 ? shuffledIncorrect[Math.floor(Math.random() * shuffledIncorrect.length)] : { id: -1, word: '錯誤答案' }
                    ]);
                    
                    // 隨機選擇兩個不重複的洞口
                    const holeIndices = [];
                    while (holeIndices.length < 2) {
                        const randomIndex = Math.floor(Math.random() * moleHoles.length);
                        if (!holeIndices.includes(randomIndex)) {
                            holeIndices.push(randomIndex);
                        }
                    }

                    // 將兩個答案分別放入兩個洞口
                    holeIndices.forEach((index, i) => {
                        const hole = moleHoles[index];
                        const moleContent = answersToPop[i];
                        
                        const moleCard = document.createElement('div');
                        moleCard.classList.add('card', 'mole-card', 'flex', 'items-center', 'justify-center', 'p-4', 'font-bold', 'select-none', 'pop-purple');
                        moleCard.dataset.id = moleContent.id;
                        moleCard.innerText = moleContent.word;
                        moleCard.style.fontSize = Math.min(20, 160 / Math.sqrt(moleContent.word.length)) + 'px';
                        
                        // 移除舊的事件監聽器，避免多次綁定
                        const existingMole = hole.querySelector('.mole-card');
                        if(existingMole) existingMole.removeEventListener('click', handleWhacAMoleClick);

                        hole.innerHTML = ''; // 清空洞
                        hole.appendChild(moleCard);
                        
                        // 淡入動畫啟動 (0.5秒)
                        setTimeout(() => {
                            moleCard.classList.add('popped');
                        }, 10);
                        
                        activeMoles.push(moleCard);
                        moleCard.addEventListener('click', handleWhacAMoleClick);
                    });

                    // 地鼠固定停留時間為 2 秒 (淡出會在 2.0 秒後開始)
                    const popDuration = 2000; 
                    moleTimeout = setTimeout(() => {
                        // 淡出動畫啟動 (0.5秒)
                        activeMoles.forEach(mole => mole.classList.remove('popped'));
                        activeMoles = [];
                    }, popDuration);

                }, popInterval);
            }

            function handleWhacAMoleClick() {
                if (!canFlip || activeMoles.length === 0) return;
                const clickedCard = this;
                
                if (parseInt(clickedCard.dataset.id) === currentQuestion.id) {
                    // 正確擊中
                    canFlip = false;
                    clearTimers(); // 停止目前的 mole loop
                    showStatus('答對了！🎉', 'pop-green');
                    clickedCard.classList.remove('popped'); // 讓被點擊的地鼠立即淡出
                    
                    setTimeout(() => {
                        questionIndex++;
                        updateWhacAMoleGame(); // 進入下一題或結束遊戲，會重新啟動計時
                    }, 1000);
                } else {
                    // 打錯
                    showStatus('打錯了！❌', 'pop-red');
                    clickedCard.classList.add('unmatched');
                    setTimeout(() => {
                        clickedCard.classList.remove('unmatched');
                        showStatus('', '');
                    }, 500);
                }
            }

            function endGame(isWin) {
                stopTimer(); // 停止總計時器
                canFlip = false;
                
                let resultMessage = '';
                if (isWin) {
                    const elapsedTime = (Date.now() - startTime) / 1000;
                    const formattedTime = formatTime(elapsedTime);
                    resultMessage = `恭喜你，全部配對成功！🎉 總耗時: ${formattedTime}`;
                    
                    whacAMoleQuestion.classList.add('hidden');
                    gameBoard.innerHTML = '';
                    showStatus(resultMessage, 'pop-green');
                    gameInfo.innerText = `最終時間: ${formattedTime}`; // Update info bar with final time
                } else {
                    whacAMoleQuestion.classList.add('hidden');
                    resultMessage = '遊戲結束。';
                    showStatus(resultMessage, 'pop-red');
                    gameInfo.innerText = ''; // Clear timer display if failed/abandoned
                    gameInfo.classList.add('hidden');
                }
                restartBtn.classList.remove('hidden');
            }

            // --- 事件監聽器 ---

            zhuyinToggle.addEventListener('change', (event) => {
                if (event.target.checked) {
                    body.classList.add('use-zhuyin');
                } else {
                    body.classList.remove('use-zhuyin');
                }
            });

            generateBtn.addEventListener('click', () => {
                gameContainer.style.display = 'block';
                startGame(gameMode);
            });

            restartBtn.addEventListener('click', () => {
                startGame(gameMode);
            });
            
            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    startGame(button.dataset.mode);
                });
            });
            
            // 初始啟動邏輯：檢查預填內容並自動啟動遊戲
            modeButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-mode="flashcard"]`).classList.add('active'); 
            gameMode = 'flashcard';
            gameContainer.style.display = 'none';
            gameInfo.classList.add('hidden');

            if (questionInput.value.trim().length > 0) {
                gameContainer.style.display = 'block';
                // 延遲啟動以確保所有 DOM 元素準備就緒
                setTimeout(() => {
                    startGame('flashcard');
                }, 100);
            } else {
                showStatus('請在編輯器中修改題目內容並重新整理頁面。', 'pop-blue');
            }
        });
    </script>


</body></html>