<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式測驗影片</title>
    <style>
        body{font-family:"Noto Sans TC",sans-serif;background:linear-gradient(135deg,#FFD700 0%,#FF8C00 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:2rem;box-sizing:border-box;margin:0}
        .main-container{width:100%;max-width:900px;background-color:#ffffff;border-radius:2rem;box-shadow:0 25px 50px -12px rgba(0,0,0,.25),0 10px 10px -5px rgba(0,0,0,.08);padding:2rem;border:8px solid #FF6347; display: flex; flex-direction: column; gap: 2rem;}
        .video-container{position:relative;width:100%;padding-bottom:56.25%;height:0;border-radius:1.5rem;overflow:hidden;box-shadow:0 15px 25px -5px rgba(0,0,0,.15);border:5px solid #FFD700}
        .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}
        .quiz-container { width: 100%; }
        .quiz-tabs { display: flex; flex-wrap: wrap; border-bottom: 3px solid #FF6347; margin-bottom: 1.5rem; }
        .quiz-tabs button { padding: 1rem 1.5rem; cursor: pointer; border: none; background-color: transparent; font-size: 1.1rem; font-weight: 700; color: #4B0082; border-radius: 0.75rem 0.75rem 0 0; transition: all 0.3s ease; }
        .quiz-tabs button.active { background-color: #FF6347; color: white; }
        .quiz-tabs button:disabled { color: #aaa; cursor: not-allowed; background-color: #f0f0f0; }
        .quiz-panel { display: none; padding: 1.5rem; background-color: #F8F8FF; border-radius: 1.5rem; border: 2px dashed #9370DB; }
        .quiz-panel.active { display: block; }
        .quiz-panel h3{font-size:1.8rem;font-weight:700;color:#4B0082;margin-bottom:1.5rem;font-family:"Fredoka One",cursive;-webkit-text-stroke:1px #9370DB;text-stroke:1px #9370DB; text-align: center;}
        .question-options{display:flex;flex-wrap:wrap;justify-content:center;gap:1.25rem;width:100%;max-width:700px; margin: 0 auto;}
        .question-options button{display:flex; align-items:center; justify-content:center; background-color:#E0FFFF;color:#000080;padding:1rem 1.5rem;border-radius:1rem;width:calc(50% - 0.625rem);text-align:center;transition:all .2s ease-in-out;box-shadow:0 4px 0px #ADD8E6;font-size:1rem;font-weight:600;border:2px solid #87CEFA;cursor:pointer}
        .question-options button .icon { font-size: 1.2em; margin-right: 0.5rem; line-height: 1; }
        @media (max-width:640px){.question-options button{width:100%}}
        .question-options button:hover:not(:disabled){background-color:#B0E0E6;transform:translateY(-2px);box-shadow:0 6px 0px #6A5ACD}
        .question-options button.correct{background-color:#98FB98!important;color:#006400!important;border:4px solid #3CB371;box-shadow:0 4px 0px #2E8B57}
        .question-options button.incorrect{background-color:#FFB6C1!important;color:#8B0000!important;border:4px solid #FF4500;box-shadow:0 4px 0px #CD5C5C}
        .question-options button:disabled { cursor: not-allowed; opacity: 0.9; }
        .explanation-box{display:none; background-color:#FFFACD;border-left:6px solid #FFA500;padding:1.2rem 1.8rem;border-radius:1rem;margin-top:1.8rem;color:#8B4513;text-align:left;width:100%;font-size:1.1rem;line-height:1.6;box-shadow:0 4px 8px rgba(0,0,0,.1);}
        .explanation-box.visible{display:block;}
        #resultsContainer{margin-top:2rem;background-color:#fff;padding:1.5rem;border-radius:1rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);text-align:left;}
        #resultsContainer h3{font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:#111827;}
        #resultsContainer table{width:100%;border-collapse:collapse;margin-top:1rem;}
        #resultsContainer th, #resultsContainer td{border:1px solid #e5e7eb;padding:0.75rem;text-align:left;}
        #resultsContainer th{background-color:#f9fafb;font-weight:600;color:#374151;}
        #resultsContainer .correct-answer-text{color:#065f46;font-weight:bold;}
        #resultsContainer .incorrect-answer-text{color:#991b1b;font-weight:bold;}
        .download-btn-small { background-color: #1E90FF; color: white; padding: 0.5rem 1rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; box-shadow: 0 4px 0px #4169E1; font-size: 0.9rem; margin-top: 1rem; }
        .download-btn-small:hover { background-color: #4169E1; transform: translateY(-1px); box-shadow: 0 6px 0px #0000CD; }
        .made-by-text-download{position:fixed;bottom:1rem;left:1rem;font-family:"Fredoka One",cursive;font-size:1rem;color:#4B0082;text-shadow:1px 1px 0px #FFD700;z-index:50;}
    </style>
</head>
<body>
    <div class="main-container">
        <div class="video-container"><div id="player"></div></div>
        <div class="quiz-container">
            <div id="quizTabs" class="quiz-tabs"></div>
            <div id="quizPanels" class="quiz-panels"></div>
        </div>
    </div>
    <div class="made-by-text-download">Made by 阿剛老師</div>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        const VIDEO_ID = "aF4vh6zHLQs";
        const QUIZ_QUESTIONS = [
  {
    "question": "阿明爺爺在節目中已經累積了多少獎金？",
    "timestamp": 0,
    "options": {
      "A": "十萬",
      "B": "A",
      "C": "五十萬",
      "D": "C"
    },
    "correctAnswer": "B",
    "explanation": "一百萬",
    "id": "q-1759494413996-0"
  },
  {
    "question": "十二月的台北平均溫度大約是多少？",
    "timestamp": 0,
    "options": {
      "A": "八度",
      "B": "B",
      "C": "十二度",
      "D": "C"
    },
    "correctAnswer": "C",
    "explanation": "十八度",
    "id": "q-1759494413996-1"
  },
  {
    "question": "阿明爺爺判斷七月的溫度大約是多少？",
    "timestamp": 0,
    "options": {
      "A": "十五度",
      "B": "B",
      "C": "二十二度",
      "D": "C"
    },
    "correctAnswer": "D",
    "explanation": "二十八度",
    "id": "q-1759494413996-2"
  },
  {
    "question": "澳洲十二月的聖誕節大約多少度？",
    "timestamp": 0,
    "options": {
      "A": "十度",
      "B": "B",
      "C": "二十九度",
      "D": "C"
    },
    "correctAnswer": "B",
    "explanation": "十八度",
    "id": "q-1759494413996-3"
  },
  {
    "question": "為什麼同樣是十二月，台北冷而澳洲熱？",
    "timestamp": 0,
    "options": {
      "A": "因為南北半球季節相反",
      "B": "A",
      "C": "因為南北半球季節相反",
      "D": "B"
    },
    "correctAnswer": "A",
    "explanation": "因為澳洲比較靠近赤道",
    "id": "q-1759494413996-4"
  }
];
        let player, quizResults = [];
        const tabsContainer = document.getElementById('quizTabs');
        const panelsContainer = document.getElementById('quizPanels');

        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
        }

        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('player', { videoId: VIDEO_ID, playerVars: {'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1} });
        };

        function initializeQuiz() {
            quizResults = Array(QUIZ_QUESTIONS.length).fill(null);
            
            QUIZ_QUESTIONS.forEach((q, index) => {
                const tabBtn = document.createElement('button');
                tabBtn.textContent = `問題 ${index + 1}`;
                tabBtn.dataset.index = index;
                tabBtn.onclick = () => showTab(index);
                tabsContainer.appendChild(tabBtn);

                const panel = document.createElement('div');
                panel.className = 'quiz-panel';
                panel.dataset.index = index;
                panel.innerHTML = `
                    <h3>${q.question}</h3>
                    <div class="question-options"></div>
                    <div class="explanation-box"><p></p></div>
                `;
                panelsContainer.appendChild(panel);
                
                const optionsContainer = panel.querySelector('.question-options');
                const optionKeys = Object.keys(q.options).sort(() => Math.random() - 0.5);
                optionKeys.forEach(key => {
                    const optBtn = document.createElement('button');
                    optBtn.innerHTML = `<span>${q.options[key]}</span>`;
                    optBtn.dataset.key = key;
                    optBtn.onclick = () => selectAnswer(optBtn, index);
                    optionsContainer.appendChild(optBtn);
                });
            });

            const resultsTabBtn = document.createElement('button');
            resultsTabBtn.textContent = '查看結果';
            resultsTabBtn.dataset.index = 'results';
            resultsTabBtn.disabled = true;
            resultsTabBtn.onclick = () => showTab('results');
            tabsContainer.appendChild(resultsTabBtn);

            const resultsPanel = document.createElement('div');
            resultsPanel.className = 'quiz-panel';
            resultsPanel.dataset.index = 'results';
            resultsPanel.id = 'resultsContainer';
            panelsContainer.appendChild(resultsPanel);

            showTab(0);
        }

        function showTab(indexToShow) {
            tabsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            panelsContainer.querySelectorAll('.quiz-panel').forEach(panel => panel.classList.remove('active'));
            const tab = tabsContainer.querySelector(`button[data-index="${indexToShow}"]`);
            const panel = panelsContainer.querySelector(`.quiz-panel[data-index="${indexToShow}"]`);
            if (tab) tab.classList.add('active');
            if (panel) panel.classList.add('active');
            if (indexToShow === 'results') displayResults();
        }

        function selectAnswer(selectedBtn, qIndex) {
            const question = QUIZ_QUESTIONS[qIndex];
            const panel = selectedBtn.closest('.quiz-panel');
            const options = panel.querySelectorAll('.question-options button');
            
            options.forEach(btn => {
                btn.disabled = true;
                const originalHTML = btn.innerHTML;
                if (btn.dataset.key === question.correctAnswer) {
                    btn.classList.add('correct');
                    btn.innerHTML = `<span class="icon">&#9675;</span>${originalHTML}`;
                } else if (btn === selectedBtn) {
                    btn.classList.add('incorrect');
                    btn.innerHTML = `<span class="icon">&#10007;</span>${originalHTML}`;
                }
            });
            
            quizResults[qIndex] = { selectedAnswerKey: selectedBtn.dataset.key, isCorrect: selectedBtn.dataset.key === question.correctAnswer };
            
            const expBox = panel.querySelector('.explanation-box');
            expBox.querySelector('p').textContent = question.explanation;
            expBox.classList.add('visible');
            
            checkCompletion();
        }

        function checkCompletion() {
            const answeredCount = quizResults.filter(r => r !== null).length;
            if (answeredCount === QUIZ_QUESTIONS.length) {
                const resultsTab = tabsContainer.querySelector('button[data-index="results"]');
                if (resultsTab) resultsTab.disabled = false;
            }
        }

        // 新增函式：下載結果為圖片
        async function downloadQuizResult() {
            const resultsContainer = document.getElementById('resultsContainer');
            if (!resultsContainer) {
                alert('找不到測驗結果區塊。');
                return;
            }
            
            // 隱藏下載按鈕本身，以免被截圖
            const downloadBtn = document.getElementById('downloadResultBtn');
            if (downloadBtn) downloadBtn.style.display = 'none';

            try {
                const canvas = await html2canvas(resultsContainer, {
                    scale: 2, // 提高解析度
                    backgroundColor: '#ffffff', // 確保背景為白色
                    logging: false,
                });

                const image = canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
                const a = document.createElement('a');
                a.href = image;
                a.download = '測驗結果.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('測驗結果圖片已成功下載！');

            } catch (error) {
                console.error('生成圖片失敗:', error);
                alert('生成圖片失敗，請再試一次。');
            } finally {
                if (downloadBtn) downloadBtn.style.display = 'block';
            }
        }
        
        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const correctCount = quizResults.filter(r => r && r.isCorrect).length;
            resultsContainer.innerHTML = `<h3>測驗結果 - 答對 ${correctCount} / ${QUIZ_QUESTIONS.length} 題</h3>`;
            
            const table = document.createElement('table');
            let tableHTML = `<thead><tr><th>編號</th><th>問題</th><th>您的答案</th><th>正確答案</th><th>結果</th><th>解析</th></tr></thead><tbody>`;
            QUIZ_QUESTIONS.forEach((q, index) => {
                const result = quizResults[index];
                const selectedText = result ? q.options[result.selectedAnswerKey] : '未作答';
                const correctText = q.options[q.correctAnswer];
                const resultText = result ? (result.isCorrect ? '<span class="correct-answer-text">答對</span>' : '<span class="incorrect-answer-text">答錯</span>') : '未作答';
                tableHTML += `<tr><td>${index + 1}</td><td>${q.question}</td><td>${selectedText}</td><td>${correctText}</td><td>${resultText}</td><td>${q.explanation}</td></tr>`;
            });
            table.innerHTML = tableHTML + '</tbody>';
            resultsContainer.appendChild(table);

            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'downloadResultBtn';
            downloadBtn.textContent = '下載結果圖片';
            downloadBtn.className = 'download-btn-small';
            downloadBtn.onclick = downloadQuizResult;
            resultsContainer.appendChild(downloadBtn);
        }

        window.addEventListener('load', () => {
            loadYouTubeAPI();
            initializeQuiz();
        });
    </script>
</body>
</html>